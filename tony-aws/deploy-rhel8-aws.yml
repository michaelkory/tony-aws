---
  - name: Deploying AWS instance
    hosts: localhost
    connection: local
    gather_facts: no
    vars_files:
    - group_vars/all


    tasks:
    - name: Creating {{target_hostname}} on AWS in the {{region}} region
      ec2:
        key_name: "{{key_name}}"
        instance_type: "{{instance_type}}"
        image:  "{{image}}"
        wait: "{{wait}}"
        group: "{{group}}"
        wait_timeout: 503
        count: "{{count}}"
        region: "{{region}}"
        vpc_subnet_id:  "{{vpc_subnet_id}}"
        assign_public_ip: "{{assign_public_ip}}"
        instance_tags:
          AlwaysUp: "{{alwaysup}}"
          Name: "{{target_hostname}}"
          Contact: "{{my_email_address}}"
          DeleteBy: "{{deleteby}}"
      register: ec2

    - name: Waiting for SSH to come up on {{ target_hostname }}
      wait_for:
        host: "{{ item.public_dns_name }}"
        port: 22
        delay: 30
        timeout: 600
      with_items: "{{ ec2.instances }}"

    - name: Add hosts to in memory inventory
      add_host:
        name: "{{ item.public_dns_name }}"
        ansible_host: "{{ item.public_dns_name }}"
        ansible_user: ec2-user
        groups: new-hosts
      with_items:
      - "{{ ec2.instances }}"

  - name: Join Satellite and Apply Updates
    hosts: new-hosts
    become: true
    tasks:
    - name: Install the katello-ca-consumer-latest.noarch.rpm from {{ sat6_fqdn }}
      yum:
        name: http://{{ sat6_fqdn }}/pub/katello-ca-consumer-latest.noarch.rpm
        state: present

    - name: Register to Satellite6 only for content
      redhat_subscription:
        state: present
        activationkey: "{{ activationkey }}"
        org_id: "{{ org }}"
        autosubscribe: true

    - name: Apply Yum Updates
      yum:
        name: "*"
        state: latest